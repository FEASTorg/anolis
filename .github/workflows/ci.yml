name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# vcpkg commit from the official release 2026.01.16
# https://github.com/microsoft/vcpkg/releases/tag/2026.01.16
env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  build-linux:
    name: Linux (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Override anolis submodule with current commit
        run: |
          cd anolis-provider-sim/external/anolis
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}
          cd ../../..

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ccache g++ python3 python3-pip
          python3 -m pip install --upgrade pip
          # Configure ccache
          /usr/sbin/update-ccache-symlinks
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
          export PATH="/usr/lib/ccache:$PATH"
          ccache --set-config=max_size=1G

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-linux-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-linux-${{ github.ref_name }}-
            ccache-linux-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Python packages
        run: |
          python -m pip install -r requirements.txt

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Build anolis
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_INSTALLED_DIR=$GITHUB_WORKSPACE/build/vcpkg_installed \
            -DVCPKG_MANIFEST_INSTALL=OFF \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build --config Release --parallel

      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure -C Release

      - name: Run integration tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib
        run: |
          set +e  # Don't exit on error so we can capture diagnostics

          # Smoke test: verify binaries can start
          echo "=== Smoke test: runtime --help ==="
          timeout 10 build/core/anolis-runtime --help || echo "Runtime help exit: $?"

          echo "=== Smoke test: provider-sim --help ==="
          timeout 10 $GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim --help || echo "Provider help exit: $?"

          echo "=== Memory status before tests ==="
          free -m

          echo "=== Running tests ==="
          python3 tests/integration/test_all.py --timeout=120 \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim
          TEST_EXIT=$?

          # On failure, show diagnostics
          if [ $TEST_EXIT -ne 0 ]; then
            echo "=== Test failed with exit code $TEST_EXIT ==="
            echo "=== Memory status after tests ==="
            free -m
            echo "=== Checking for OOM kills ==="
            dmesg 2>/dev/null | grep -i "oom\|killed" | tail -20 || true
            echo "=== Top memory consumers ==="
            ps aux --sort=-rss | head -10 || true
            echo "=== Test log tails ==="
            tail -100 build/test-logs/*.log 2>/dev/null || true
          fi
          ccache -s
          exit $TEST_EXIT

      - name: Run validation scenarios
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib
        run: |
          echo "=== Running validation scenario suite ==="
          python3 tests/scenarios/run_scenarios.py \
            --runtime=build/core/anolis-runtime \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim

      - name: Upload Test Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-linux
          path: build/test-logs/

  build-windows:
    name: Windows (MSVC 2022)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Override anolis submodule with current commit
        run: |
          cd anolis-provider-sim/external/anolis
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Build anolis
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release `
            "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            "-DVCPKG_INSTALLED_DIR=$env:GITHUB_WORKSPACE/build/vcpkg_installed" `
            "-DVCPKG_MANIFEST_INSTALL=OFF"
          cmake --build build --config Release --parallel

      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure -C Release

      - name: Run integration tests
        run: |
          python tests/integration/test_all.py --timeout=120 "--provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe"

      - name: Run validation scenarios
        run: |
          Write-Host "=== Running validation scenario suite ==="
          python tests/scenarios/run_scenarios.py `
            "--runtime=build/core/Release/anolis-runtime.exe" `
            "--provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe"

      - name: Upload Test Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows
          path: build/test-logs/
