name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  format-check:
    name: C++ Formatting (clang-format)
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          set -euo pipefail
          FILES=$(find core tests -type f \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' \))
          if [ -z "$FILES" ]; then
            echo "No C++ files found"
            exit 1
          fi
          echo "$FILES" | xargs clang-format --dry-run --Werror

  python-lint:
    name: Python Linting (ruff)
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.15.0

      - name: Run ruff checks
        run: |
          ruff check . --output-format=github
          ruff format --check .

  python-typecheck:
    name: Python Type Checking (mypy)
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-lock.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-lock.txt

      - name: Run mypy
        run: mypy .

  core-build-test:
    name: ${{ matrix.lane }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 50
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: Linux Release (Core)
            os: ubuntu-24.04
            configure_preset: ci-linux-release
            test_preset: ci-linux-release
          - lane: Windows Release (Core)
            os: windows-2022
            configure_preset: ci-windows-release
            test_preset: ci-windows-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++

      - name: Validate requirements lockfile
        shell: bash
        run: |
          set -euo pipefail
          LOCKFILE="requirements-lock.txt"
          test -f "$LOCKFILE"
          if od -An -tx1 "$LOCKFILE" | tr -s ' ' '\n' | grep -qx '00'; then
            echo "ERROR: $LOCKFILE contains NUL bytes (binary corruption)" >&2
            exit 1
          fi
          iconv -f UTF-8 -t UTF-8 "$LOCKFILE" > /dev/null 2>&1
          echo "OK: $LOCKFILE is valid UTF-8 and contains no NUL bytes"

      - name: Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-lock.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-lock.txt

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset "${{ matrix.configure_preset }}"

      - name: Build
        run: cmake --build --preset "${{ matrix.configure_preset }}" --parallel

      - name: Run CTest
        run: ctest --preset "${{ matrix.test_preset }}"

  anolis-provider-compat:
    name: anolis-provider-compat
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++


      - name: Resolve provider pin
        id: pins
        run: |
          set -euo pipefail
          PROVIDER_REPO=$(awk '/provider_sim:/{f=1; next} f && /repository:/{print $2; exit}' .ci/dependency-pins.yml)
          PROVIDER_REF=$(awk '/provider_sim:/{f=1; next} f && /ref:/{print $2; exit}' .ci/dependency-pins.yml)
          if [ -z "$PROVIDER_REPO" ] || [ -z "$PROVIDER_REF" ]; then
            echo "Failed to resolve provider pin from .ci/dependency-pins.yml" >&2
            exit 1
          fi
          echo "repo=$PROVIDER_REPO" >> "$GITHUB_OUTPUT"
          echo "ref=$PROVIDER_REF" >> "$GITHUB_OUTPUT"
          echo "Using provider pin: $PROVIDER_REPO@$PROVIDER_REF"

      - name: Checkout pinned provider-sim
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pins.outputs.repo }}
          ref: ${{ steps.pins.outputs.ref }}
          path: anolis-provider-sim
          submodules: recursive

      - name: Validate requirements lockfile
        shell: bash
        run: |
          set -euo pipefail
          LOCKFILE="requirements-lock.txt"
          test -f "$LOCKFILE"
          if od -An -tx1 "$LOCKFILE" | tr -s ' ' '\n' | grep -qx '00'; then
            echo "ERROR: $LOCKFILE contains NUL bytes (binary corruption)" >&2
            exit 1
          fi
          iconv -f UTF-8 -t UTF-8 "$LOCKFILE" > /dev/null 2>&1
          echo "OK: $LOCKFILE is valid UTF-8 and contains no NUL bytes"

      - name: Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-lock.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-lock.txt

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Build pinned provider-sim (FluxGraph OFF)
        working-directory: anolis-provider-sim
        run: |
          cmake --preset ci-linux-release
          cmake --build --preset ci-linux-release --parallel

      - name: Resolve provider executable
        id: provider
        run: |
          set -euo pipefail
          EXE="$GITHUB_WORKSPACE/anolis-provider-sim/build/ci-linux-release/anolis-provider-sim"
          if [ ! -x "$EXE" ]; then
            echo "Provider executable not found: $EXE" >&2
            exit 1
          fi
          echo "exe=$EXE" >> "$GITHUB_OUTPUT"

      - name: Configure compatibility preset
        run: |
          cmake --preset ci-linux-compat \
            -DANOLIS_ENABLE_PYTHON_CTEST=ON \
            -DANOLIS_PROVIDER_SIM_EXE="${{ steps.provider.outputs.exe }}"

      - name: Build compatibility preset
        run: cmake --build --preset ci-linux-compat --parallel

      - name: Run CTest compatibility entrypoint (Python)
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/ci-linux-compat/vcpkg_installed/x64-linux/lib
        run: ctest --preset ci-linux-compat -L integration
