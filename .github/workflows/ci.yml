name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# vcpkg commit from the official release 2026.01.16
# https://github.com/microsoft/vcpkg/releases/tag/2026.01.16
env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  build-linux:
    name: Linux (Ubuntu 24.04)
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: ./.github/actions/checkout-provider-sim
        with:
          commit-sha: ${{ github.sha }}

      - name: Validate requirements-lock.txt encoding
        uses: ./.github/actions/validate-lockfile

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ccache g++ python3 python3-pip
          python3 -m pip install --upgrade pip
          # Configure ccache
          /usr/sbin/update-ccache-symlinks
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
          export PATH="/usr/lib/ccache:$PATH"
          ccache --set-config=max_size=1G

      - name: Compute safe cache key fragment
        id: safe-ref
        shell: bash
        run: |
          SAFE_REF_NAME="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          SAFE_REF_NAME="${SAFE_REF_NAME//\//-}"
          echo "value=$SAFE_REF_NAME" >> "$GITHUB_OUTPUT"

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-linux-${{ steps.safe-ref.outputs.value }}-${{ github.sha }}
          restore-keys: |
            ccache-linux-${{ steps.safe-ref.outputs.value }}-
            ccache-linux-

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps

      - name: Setup vcpkg
        uses: ./.github/actions/setup-vcpkg
        with:
          vcpkg-commit: ${{ env.VCPKG_COMMIT }}

      - name: Build anolis
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_INSTALLED_DIR=$GITHUB_WORKSPACE/build/vcpkg_installed \
            -DVCPKG_MANIFEST_INSTALL=OFF \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build --config Release --parallel

      - name: Run unit tests
        run: |
          set +e
          echo "=== Running CTest ==="
          ctest --test-dir build --output-on-failure -C Release 2>&1 | tee ctest-output.log
          CTEST_EXIT=$?

          # Parse test results
          TOTAL_TESTS=$(grep -oP '\d+(?= tests)' ctest-output.log | tail -1 || echo "0")
          PASSED_TESTS=$(grep -oP '\d+(?= tests passed)' ctest-output.log | tail -1 || echo "0")
          FAILED_TESTS=$(grep -oP '\d+(?= tests failed)' ctest-output.log | tail -1 || echo "0")

          {
            echo "## Unit Tests (Linux)"
            echo ""
            if [ $CTEST_EXIT -eq 0 ]; then
              echo "**PASS:** All unit tests passed"
            else
              echo "**FAIL:** Unit tests failed"
            fi
            echo ""
            echo "- Total: $TOTAL_TESTS"
            echo "- Passed: $PASSED_TESTS"
            echo "- Failed: $FAILED_TESTS"
            echo ""
            if [ $CTEST_EXIT -ne 0 ]; then
              echo "See logs in artifact: \`test-logs-linux-${{ github.run_number }}\`"
            fi
          } >> $GITHUB_STEP_SUMMARY

          exit $CTEST_EXIT

      - name: Run integration tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib
        run: |
          set +e  # Don't exit on error so we can capture diagnostics

          # Smoke test: verify binaries can start
          echo "=== Smoke test: runtime --help ==="
          timeout 10 build/core/anolis-runtime --help || echo "Runtime help exit: $?"

          echo "=== Smoke test: provider-sim --help ==="
          timeout 10 $GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim --help || echo "Provider help exit: $?"

          echo "=== Memory status before tests ==="
          free -m

          echo "=== Running tests ==="
          START_TIME=$(date +%s)
          python3 tests/integration/test_all.py --timeout=120 \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim 2>&1 | tee integration-test.log
          TEST_EXIT=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Count test results from pytest output
          TEST_COUNT=$(grep -oP '\d+(?= passed|failed|error)' integration-test.log | head -1 || echo "N/A")

          {
            echo "## Integration Tests (Linux)"
            echo ""
            if [ $TEST_EXIT -eq 0 ]; then
              echo "**PASS:** All integration tests passed"
            else
              echo "**FAIL:** Integration tests failed"
            fi
            echo ""
            echo "- Duration: ${DURATION}s"
            echo "- Tests: $TEST_COUNT"
            echo "- Exit code: $TEST_EXIT"
            echo ""
            if [ $TEST_EXIT -ne 0 ]; then
              echo "### Diagnostics captured:"
              echo "- Memory status"
              echo "- OOM check"
              echo "- Test log tails"
              echo ""
              echo "Artifact: \`test-logs-linux-${{ github.run_number }}\`"
            fi
          } >> $GITHUB_STEP_SUMMARY

          # On failure, show diagnostics
          if [ $TEST_EXIT -ne 0 ]; then
            echo "=== Test failed with exit code $TEST_EXIT ==="
            echo "=== Memory status after tests ==="
            free -m
            echo "=== Checking for OOM kills ==="
            dmesg 2>/dev/null | grep -i "oom\|killed" | tail -20 || true
            echo "=== Top memory consumers ==="
            ps aux --sort=-rss | head -10 || true
            echo "=== Test log tails ==="
            tail -100 build/test-logs/*.log 2>/dev/null || true
          fi
          ccache -s
          exit $TEST_EXIT

      - name: Run validation scenarios
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib
        run: |
          set +e
          echo "=== Running validation scenario suite ==="
          python3 tests/scenarios/run_scenarios.py \
            --runtime=build/core/anolis-runtime \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim 2>&1 | tee scenarios.log
          SCENARIO_EXIT=$?

          {
            echo "## Validation Scenarios (Linux)"
            echo ""
            if [ $SCENARIO_EXIT -eq 0 ]; then
              echo "**PASS:** All scenarios passed"
            else
              echo "**FAIL:** Scenarios failed"
              echo ""
              echo "Exit code: $SCENARIO_EXIT"
              echo ""
              echo "Artifact: \`test-logs-linux-${{ github.run_number }}\`"
            fi
          } >> $GITHUB_STEP_SUMMARY

          exit $SCENARIO_EXIT

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-linux-${{ github.run_number }}
          path: |
            build/test-logs/
            ctest-output.log
            integration-test.log
            scenarios.log
          if-no-files-found: ignore
          retention-days: 7

  build-windows:
    name: Windows (MSVC 2022)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: ./.github/actions/checkout-provider-sim
        with:
          commit-sha: ${{ github.sha }}

      - name: Validate requirements-lock.txt encoding
        uses: ./.github/actions/validate-lockfile

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          upgrade-pip: "true"

      - name: Setup vcpkg
        uses: ./.github/actions/setup-vcpkg
        with:
          vcpkg-commit: ${{ env.VCPKG_COMMIT }}

      - name: Build anolis
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release `
            "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            "-DVCPKG_INSTALLED_DIR=$env:GITHUB_WORKSPACE/build/vcpkg_installed" `
            "-DVCPKG_MANIFEST_INSTALL=OFF"
          cmake --build build --config Release --parallel

      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure -C Release 2>&1 | Tee-Object -FilePath ctest-output.log
          $CTEST_EXIT = $LASTEXITCODE

          # Parse test results
          $TestOutput = Get-Content ctest-output.log -Raw
          $TotalTests = if ($TestOutput -match '(\d+) tests') { $Matches[1] } else { "0" }
          $PassedTests = if ($TestOutput -match '(\d+) tests passed') { $Matches[1] } else { "0" }
          $FailedTests = if ($TestOutput -match '(\d+) tests failed') { $Matches[1] } else { "0" }

          $Summary = "## Unit Tests (Windows)`n`n"
          if ($CTEST_EXIT -eq 0) {
            $Summary += "**PASS:** All unit tests passed`n"
          } else {
            $Summary += "**FAIL:** Unit tests failed`n"
          }
          $Summary += "`n- Total: $TotalTests`n"
          $Summary += "- Passed: $PassedTests`n"
          $Summary += "- Failed: $FailedTests`n`n"
          if ($CTEST_EXIT -ne 0) {
            $Summary += "Artifact: ``test-logs-windows-${{ github.run_number }}``n"
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $Summary

          if ($CTEST_EXIT -ne 0) { exit $CTEST_EXIT }

      - name: Run integration tests
        run: |
          $StartTime = Get-Date
          python tests/integration/test_all.py --timeout=120 "--provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe" 2>&1 | Tee-Object -FilePath integration-test.log
          $TEST_EXIT = $LASTEXITCODE
          $EndTime = Get-Date
          $Duration = [int](($EndTime - $StartTime).TotalSeconds)

          $TestOutput = Get-Content integration-test.log -Raw
          $TestCount = if ($TestOutput -match '(\d+) (passed|failed|error)') { $Matches[1] } else { "N/A" }

          $Summary = "## Integration Tests (Windows)`n`n"
          if ($TEST_EXIT -eq 0) {
            $Summary += "**PASS:** All integration tests passed`n"
          } else {
            $Summary += "**FAIL:** Integration tests failed`n"
          }
          $Summary += "`n- Duration: ${Duration}s`n"
          $Summary += "- Tests: $TestCount`n"
          $Summary += "- Exit code: $TEST_EXIT`n`n"
          if ($TEST_EXIT -ne 0) {
            $Summary += "Artifact: ``test-logs-windows-${{ github.run_number }}``n"
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $Summary

          if ($TEST_EXIT -ne 0) { exit $TEST_EXIT }

      - name: Run validation scenarios
        run: |
          Write-Host "=== Running validation scenario suite ==="
          python tests/scenarios/run_scenarios.py `
            "--runtime=build/core/Release/anolis-runtime.exe" `
            "--provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe" 2>&1 | Tee-Object -FilePath scenarios.log
          $SCENARIO_EXIT = $LASTEXITCODE

          $Summary = "## Validation Scenarios (Windows)`n`n"
          if ($SCENARIO_EXIT -eq 0) {
            $Summary += "**PASS:** All scenarios passed`n"
          } else {
            $Summary += "**FAIL:** Scenarios failed`n`n"
            $Summary += "Exit code: $SCENARIO_EXIT`n`n"
            $Summary += "Artifact: ``test-logs-windows-${{ github.run_number }}``n"
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $Summary

          if ($SCENARIO_EXIT -ne 0) { exit $SCENARIO_EXIT }

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows-${{ github.run_number }}
          path: |
            build/test-logs/
            ctest-output.log
            integration-test.log
            scenarios.log
          if-no-files-found: ignore
          retention-days: 7
