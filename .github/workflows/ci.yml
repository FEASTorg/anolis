name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    name: Linux (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install requests

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "a34c873a9717a888f58dc05268dea15592c2f0ff"

      - name: Build anolis
        run: |
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release --parallel

      - name: Run tests
        run: |
          python3 scripts/test_all.py --timeout=120 \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim

  build-windows:
    name: Windows (MSVC 2022)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "a34c873a9717a888f58dc05268dea15592c2f0ff"

      - name: Build anolis
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release

      - name: Run tests
        run: |
          python scripts/test_all.py --timeout=120 `
            --provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe
