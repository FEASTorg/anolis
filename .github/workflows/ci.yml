name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# vcpkg commit from the official release 2026.01.16
# https://github.com/microsoft/vcpkg/releases/tag/2026.01.16
env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  build-linux:
    name: Linux (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install requests

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}

      - name: Build anolis
        run: |
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release --parallel

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_INSTALLED_DIR=$GITHUB_WORKSPACE/build/vcpkg_installed \
            -DVCPKG_MANIFEST_INSTALL=OFF
          cmake --build build --config Release --parallel

      - name: Run tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux/lib
        run: |
          # Smoke test: verify binaries can start
          echo "=== Smoke test: runtime --help ==="
          timeout 10 build/core/anolis-runtime --help || echo "Runtime help exit: $?"
          
          echo "=== Smoke test: provider-sim --help ==="
          timeout 10 $GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim --help || echo "Provider help exit: $?"
          
          echo "=== Memory status before tests ==="
          free -m
          
          echo "=== Running tests (non-verbose to prevent OOM) ==="
          python3 scripts/test_all.py --timeout=120 \
            --provider=$GITHUB_WORKSPACE/anolis-provider-sim/build/anolis-provider-sim \
            || TEST_EXIT=$?
          
          # On failure, show OOM diagnostics
          if [ "${TEST_EXIT:-0}" -ne 0 ]; then
            echo "=== Test failed with exit code $TEST_EXIT ==="
            echo "=== Memory status after tests ==="
            free -m
            echo "=== Checking for OOM kills ==="
            dmesg | grep -i "oom\|killed" | tail -20 || true
            echo "=== Top memory consumers ==="
            ps aux --sort=-rss | head -10 || true
            echo "=== Test log tails ==="
            tail -100 build/test-logs/*.log 2>/dev/null || true
            exit $TEST_EXIT
          fi

  build-windows:
    name: Windows (MSVC 2022)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout anolis
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout anolis-provider-sim
        uses: actions/checkout@v4
        with:
          repository: FEASTorg/anolis-provider-sim
          path: anolis-provider-sim
          submodules: recursive

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}

      - name: Build anolis
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build build --config Release

      - name: Build anolis-provider-sim
        run: |
          cd anolis-provider-sim
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release `
            "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            "-DVCPKG_INSTALLED_DIR=$env:GITHUB_WORKSPACE/build/vcpkg_installed" `
            "-DVCPKG_MANIFEST_INSTALL=OFF"
          cmake --build build --config Release

      - name: Run tests
        run: |
          python scripts/test_all.py --timeout=120 "--provider=$env:GITHUB_WORKSPACE/anolis-provider-sim/build/Release/anolis-provider-sim.exe"
