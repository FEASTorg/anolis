name: Runtime Sanitizers

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
      - "**/*.svg"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
      - "**/*.svg"

concurrency:
  group: sanitizers-${{ github.ref }}
  cancel-in-progress: true

env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  sanitizer-linux:
    name: ${{ matrix.lane }}
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: AddressSanitizer
            preset: ci-asan
            asan_options: log_path=asan:halt_on_error=1:detect_leaks=1:symbolize=1
            ubsan_options: ""
            log_glob: "asan.* lsan.*"
          - lane: UndefinedBehaviorSanitizer
            preset: ci-ubsan
            asan_options: ""
            ubsan_options: log_path=ubsan:halt_on_error=1:print_stacktrace=1
            log_glob: "ubsan.*"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++


      - name: Validate requirements lockfile
        uses: ./.github/actions/validate-lockfile

      - name: Setup vcpkg
        uses: ./.github/actions/setup-vcpkg
        with:
          vcpkg-commit: ${{ env.VCPKG_COMMIT }}

      - name: Configure
        run: cmake --preset "${{ matrix.preset }}"

      - name: Build
        run: cmake --build --preset "${{ matrix.preset }}" --parallel

      - name: Run tests
        env:
          ASAN_OPTIONS: ${{ matrix.asan_options }}
          UBSAN_OPTIONS: ${{ matrix.ubsan_options }}
        run: |
          set +e
          set -o pipefail
          ctest --preset "${{ matrix.preset }}" 2>&1 | tee sanitizer-output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if ls ${{ matrix.log_glob }} >/dev/null 2>&1; then
            echo "Sanitizer reports detected"
            exit 1
          fi

          exit $EXIT_CODE

      - name: Upload sanitizer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.preset }}-logs-${{ github.run_number }}
          path: |
            asan.*
            lsan.*
            ubsan.*
            sanitizer-output.log
          if-no-files-found: ignore
          retention-days: 14
