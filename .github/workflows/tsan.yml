name: ThreadSanitizer

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"

concurrency:
  group: tsan-${{ github.ref }}
  cancel-in-progress: true

env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  tsan-linux:
    name: ThreadSanitizer (Ubuntu 24.04)
    runs-on: ubuntu-24.04
    timeout-minutes: 75

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++


      - name: Validate requirements lockfile
        uses: ./.github/actions/validate-lockfile

      - name: Setup vcpkg
        uses: ./.github/actions/setup-vcpkg
        with:
          vcpkg-commit: ${{ env.VCPKG_COMMIT }}

      - name: Configure
        run: cmake --preset ci-tsan

      - name: Build
        run: cmake --build --preset ci-tsan --parallel

      - name: Run tests with TSAN
        env:
          ANOLIS_TSAN: "1"
          TSAN_OPTIONS: "second_deadlock_stack=1 detect_deadlocks=1 history_size=7 log_path=${{ github.workspace }}/tsan-report"
        run: |
          set +e
          set -o pipefail
          export CTEST_PARALLEL_LEVEL=1
          timeout 20m ctest --preset ci-tsan --timeout 300 -VV 2>&1 | tee tsan-output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if ls tsan-report.* >/dev/null 2>&1; then
            echo "ThreadSanitizer detected data races"
            exit 1
          fi

          exit $EXIT_CODE

      - name: Upload TSAN logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tsan-logs-${{ github.run_number }}
          path: |
            tsan-report.*
            tsan-output.log
            build/ci-tsan/Testing/Temporary/LastTest.log
          if-no-files-found: ignore
          retention-days: 14
