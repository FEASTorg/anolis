name: Extended Checks

on:
  push:
    branches: [main]
    paths-ignore:
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**/*.png"
      - "**/*.svg"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

concurrency:
  group: extended-${{ github.ref }}
  cancel-in-progress: true

env:
  VCPKG_COMMIT: "66c0373dc7fca549e5803087b9487edfe3aca0a1"

jobs:
  sanitizer-linux:
    name: ${{ matrix.lane }}
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: AddressSanitizer
            preset: ci-asan
            asan_options: log_path=asan:halt_on_error=1:detect_leaks=1:symbolize=1
            ubsan_options: ""
            log_glob: "asan.* lsan.*"
          - lane: UndefinedBehaviorSanitizer
            preset: ci-ubsan
            asan_options: ""
            ubsan_options: log_path=ubsan:halt_on_error=1:print_stacktrace=1
            log_glob: "ubsan.*"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++

      - name: Validate requirements lockfile
        shell: bash
        run: |
          set -euo pipefail
          LOCKFILE="requirements-lock.txt"
          test -f "$LOCKFILE"
          if od -An -tx1 "$LOCKFILE" | tr -s ' ' '\n' | grep -qx '00'; then
            echo "ERROR: $LOCKFILE contains NUL bytes (binary corruption)" >&2
            exit 1
          fi
          iconv -f UTF-8 -t UTF-8 "$LOCKFILE" > /dev/null 2>&1
          echo "OK: $LOCKFILE is valid UTF-8 and contains no NUL bytes"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset "${{ matrix.preset }}"

      - name: Build
        run: cmake --build --preset "${{ matrix.preset }}" --parallel

      - name: Run tests
        env:
          ASAN_OPTIONS: ${{ matrix.asan_options }}
          UBSAN_OPTIONS: ${{ matrix.ubsan_options }}
        run: |
          set +e
          set -o pipefail
          ctest --preset "${{ matrix.preset }}" 2>&1 | tee sanitizer-output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if ls ${{ matrix.log_glob }} >/dev/null 2>&1; then
            echo "Sanitizer reports detected"
            exit 1
          fi

          exit $EXIT_CODE

      - name: Upload sanitizer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.preset }}-logs-${{ github.run_number }}
          path: |
            asan.*
            lsan.*
            ubsan.*
            sanitizer-output.log
          if-no-files-found: ignore
          retention-days: 14

  tsan-linux:
    name: ThreadSanitizer (Ubuntu 24.04)
    runs-on: ubuntu-24.04
    timeout-minutes: 75
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++

      - name: Validate requirements lockfile
        shell: bash
        run: |
          set -euo pipefail
          LOCKFILE="requirements-lock.txt"
          test -f "$LOCKFILE"
          if od -An -tx1 "$LOCKFILE" | tr -s ' ' '\n' | grep -qx '00'; then
            echo "ERROR: $LOCKFILE contains NUL bytes (binary corruption)" >&2
            exit 1
          fi
          iconv -f UTF-8 -t UTF-8 "$LOCKFILE" > /dev/null 2>&1
          echo "OK: $LOCKFILE is valid UTF-8 and contains no NUL bytes"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset ci-tsan

      - name: Build
        run: cmake --build --preset ci-tsan --parallel

      - name: Run tests with TSAN
        env:
          ANOLIS_TSAN: "1"
          TSAN_OPTIONS: "second_deadlock_stack=1 detect_deadlocks=1 history_size=7 log_path=${{ github.workspace }}/tsan-report"
        run: |
          set +e
          set -o pipefail
          export CTEST_PARALLEL_LEVEL=1
          timeout 20m ctest --preset ci-tsan --timeout 300 -VV 2>&1 | tee tsan-output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if ls tsan-report.* >/dev/null 2>&1; then
            echo "ThreadSanitizer detected data races"
            exit 1
          fi

          exit $EXIT_CODE

      - name: Upload TSAN logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tsan-logs-${{ github.run_number }}
          path: |
            tsan-report.*
            tsan-output.log
            build/ci-tsan/Testing/Temporary/LastTest.log
          if-no-files-found: ignore
          retention-days: 14

  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy-14 ninja-build g++
          sudo ln -sf /usr/bin/clang-tidy-14 /usr/bin/clang-tidy

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset ci-linux-clang-tidy

      - name: Analyze with clang-tidy
        run: |
          set +e
          set -o pipefail
          cmake --build --preset ci-linux-clang-tidy --parallel 2>&1 | tee clang-tidy.log
          EXIT_CODE=${PIPESTATUS[0]}

          ERROR_COUNT=$(grep -c "error:" clang-tidy.log || true)
          WARNING_COUNT=$(grep -c "warning:" clang-tidy.log || true)

          if [ "$EXIT_CODE" -ne 0 ] || [ "$ERROR_COUNT" -gt 0 ]; then
            {
              echo "## Clang-Tidy Analysis Failed"
              echo ""
              echo "- **Errors:** $ERROR_COUNT"
              echo "- **Warnings:** $WARNING_COUNT"
              echo ""
              echo "### Sample Issues:"
              echo '```'
              grep -E "(error:|warning:)" clang-tidy.log | head -20
              echo '```'
              echo ""
              echo "Artifact: \`clang-tidy-log-${{ github.run_number }}\`"
            } >> "$GITHUB_STEP_SUMMARY"
            if [ "$EXIT_CODE" -ne 0 ]; then
              exit "$EXIT_CODE"
            fi
            exit 1
          fi

          {
            echo "## Clang-Tidy Analysis Passed"
            echo ""
            echo "- **Errors:** 0"
            echo "- **Warnings:** $WARNING_COUNT"
            echo ""
            if [ "$WARNING_COUNT" -gt 0 ]; then
              echo "### Sample Warnings:"
              echo '```'
              grep "warning:" clang-tidy.log | head -10
              echo '```'
              echo ""
            fi
            echo "Artifact: \`clang-tidy-log-${{ github.run_number }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload clang-tidy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-log-${{ github.run_number }}
          path: clang-tidy.log
          retention-days: 14

  coverage-linux:
    name: Coverage Analysis (Linux, Advisory)
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate requirements lockfile
        shell: bash
        run: |
          set -euo pipefail
          LOCKFILE="requirements-lock.txt"
          test -f "$LOCKFILE"
          if od -An -tx1 "$LOCKFILE" | tr -s ' ' '\n' | grep -qx '00'; then
            echo "ERROR: $LOCKFILE contains NUL bytes (binary corruption)" >&2
            exit 1
          fi
          iconv -f UTF-8 -t UTF-8 "$LOCKFILE" > /dev/null 2>&1
          echo "OK: $LOCKFILE is valid UTF-8 and contains no NUL bytes"

      - name: Install coverage tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++ lcov

      - name: Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-lock.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-lock.txt

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset ci-coverage

      - name: Build
        run: cmake --build --preset ci-coverage --parallel

      - name: Reset coverage counters
        run: lcov --rc branch_coverage=1 --directory build/ci-coverage --zerocounters

      - name: Run CTest
        run: ctest --preset ci-coverage

      - name: Collect coverage data
        run: |
          set -euo pipefail
          lcov --rc branch_coverage=1 --rc geninfo_unexecuted_blocks=1 \
            --ignore-errors mismatch,gcov \
            --directory build/ci-coverage \
            --capture \
            --output-file coverage.raw.info

          lcov --rc branch_coverage=1 --ignore-errors unused \
            --remove coverage.raw.info \
            '/usr/*' \
            '*/vcpkg_installed/*' \
            '*/build/_deps/*' \
            '*/tests/*' \
            --output-file coverage.info

          lcov --rc branch_coverage=1 --list coverage.info

      - name: Generate HTML coverage report
        run: |
          genhtml --rc branch_coverage=1 coverage.info \
            --output-directory coverage-html \
            --title "Anolis Runtime Coverage" \
            --demangle-cpp \
            --legend

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            coverage.info
            coverage-html/
          retention-days: 14

  arm64-core-advisory:
    name: ARM64 Core (Advisory)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build g++

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: false

      - name: Configure
        run: cmake --preset ci-linux-arm64-release

      - name: Build
        run: cmake --build --preset ci-linux-arm64-release --parallel

      - name: Run CTest
        run: ctest --preset ci-linux-arm64-release
